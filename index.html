<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="beilo 技术小屋">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="beilo 技术小屋">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="beilo 技术小屋">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>beilo 技术小屋</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">beilo 技术小屋</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/25/react-网易云音乐项目小结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="beilo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="beilo 技术小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/25/react-网易云音乐项目小结/" itemprop="url">react 网易云音乐项目小结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-25T10:56:34+08:00">
                2018-10-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学习搭建一个网易云音乐的项目"><a href="#学习搭建一个网易云音乐的项目" class="headerlink" title="学习搭建一个网易云音乐的项目"></a>学习搭建一个网易云音乐的项目</h1><h2 id="采用的技术框架"><a href="#采用的技术框架" class="headerlink" title="采用的技术框架"></a>采用的技术框架</h2><ul>
<li>react 视图层框架</li>
<li>bable js转译</li>
<li>webpack 打包</li>
<li>axios 网络通讯</li>
<li>dvaJs model层框架</li>
<li><a href="https://github.com/Binaryify/NeteaseCloudMusicApi" target="_blank" rel="noopener">网易云音乐api</a></li>
</ul>
<h2 id="项目步骤"><a href="#项目步骤" class="headerlink" title="项目步骤"></a>项目步骤</h2><h4 id="babel-配置"><a href="#babel-配置" class="headerlink" title="babel 配置"></a>babel 配置</h4><p>项目中使用到了最新的特性,所以针对性的配置了 <code>babel</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package.json</span><br><span class="line"></span><br><span class="line"><span class="string">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"@babel/core"</span>: <span class="string">"^7.1.2"</span>,</span><br><span class="line">    <span class="string">"@babel/plugin-proposal-class-properties"</span>: <span class="string">"^7.1.0"</span>, <span class="comment">// 支持静态属性</span></span><br><span class="line">    <span class="string">"@babel/plugin-proposal-decorators"</span>: <span class="string">"^7.1.2"</span>, <span class="comment">//支持装饰器</span></span><br><span class="line">    <span class="string">"@babel/plugin-transform-runtime"</span>: <span class="string">"^7.1.0"</span>,  <span class="comment">//供编译模块复用工具函数</span></span><br><span class="line">    <span class="string">"@babel/preset-env"</span>: <span class="string">"^7.1.0"</span>, <span class="comment">//转译所有</span></span><br><span class="line">    <span class="string">"@babel/preset-react"</span>: <span class="string">"^7.0.0"</span>, <span class="comment">//转译react代码</span></span><br><span class="line">    <span class="string">"babel-loader"</span>: <span class="string">"^8.0.4"</span>,</span><br><span class="line">    <span class="string">"babel-plugin-import"</span>: <span class="string">"^1.9.1"</span>, <span class="comment">//import 按需加载</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"@babel/runtime"</span>: <span class="string">"^7.1.2"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.babelrc</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"presets"</span>: [<span class="string">"@babel/preset-env"</span>, <span class="string">"@babel/preset-react"</span>],</span><br><span class="line">    <span class="attr">"plugins"</span>: [</span><br><span class="line">        [<span class="string">"@babel/plugin-proposal-decorators"</span>, &#123;</span><br><span class="line">            <span class="attr">"legacy"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;],</span><br><span class="line">        <span class="string">"@babel/plugin-proposal-class-properties"</span>,</span><br><span class="line">        [</span><br><span class="line">            <span class="string">"@babel/plugin-transform-runtime"</span>,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"corejs"</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">"helpers"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">"regenerator"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">"useESModules"</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="webpack-配置"><a href="#webpack-配置" class="headerlink" title="webpack 配置"></a>webpack 配置</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">webpack.config.js</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> HtmlWebPackPlugin = <span class="built_in">require</span>(<span class="string">"html-webpack-plugin"</span>); <span class="comment">//复制html并且添加js链接</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>); <span class="comment">//管理路径</span></span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: path.join(__dirname, <span class="string">"src"</span>, <span class="string">"index.jsx"</span>),</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">        filename: <span class="string">'bundle.js'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    devtool: <span class="string">'source-map'</span>,</span><br><span class="line">    resolve: &#123;</span><br><span class="line">        extensions: [<span class="string">'.js'</span>, <span class="string">'.jsx'</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [&#123;</span><br><span class="line">                test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">                exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">                use: &#123;</span><br><span class="line">                    loader: <span class="string">"babel-loader"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                exclude: [</span><br><span class="line">                    path.join(__dirname, <span class="string">'../node_modules'</span>) <span class="comment">// 由于node_modules都是编译过的文件，这里我们不让babel去处理其下面的js文件</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                test: <span class="regexp">/.jsx$/</span>, <span class="comment">//使用loader的目标文件。这里是.jsx</span></span><br><span class="line">                loader: <span class="string">'babel-loader'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.html$/</span>,</span><br><span class="line">                use: [&#123;</span><br><span class="line">                    loader: <span class="string">"html-loader"</span></span><br><span class="line">                &#125;]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">                use: [<span class="string">'style-loader'</span>, &#123;</span><br><span class="line">                    loader: <span class="string">'css-loader'</span>,</span><br><span class="line">                    <span class="comment">// options: &#123;</span></span><br><span class="line">                    <span class="comment">//     modules: true,</span></span><br><span class="line">                    <span class="comment">//     localIdentName: '[path][name]__[local]--[hash:base64:5]'</span></span><br><span class="line">                    <span class="comment">// &#125;</span></span><br><span class="line">                &#125;]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">                use: [&#123;</span><br><span class="line">                    loader: <span class="string">"style-loader"</span> <span class="comment">// creates style nodes from JS strings</span></span><br><span class="line">                &#125;, &#123;</span><br><span class="line">                    loader: <span class="string">'css-loader'</span>,</span><br><span class="line">                    <span class="comment">// options: &#123;</span></span><br><span class="line">                    <span class="comment">//     modules: true,</span></span><br><span class="line">                    <span class="comment">//     localIdentName: '[path][name]__[local]--[hash:base64:5]'</span></span><br><span class="line">                    <span class="comment">// &#125; // translates CSS into CommonJS</span></span><br><span class="line">                &#125;, &#123;</span><br><span class="line">                    loader: <span class="string">"less-loader"</span> <span class="comment">// compiles Less to CSS</span></span><br><span class="line">                &#125;],</span><br><span class="line">                include: [</span><br><span class="line">                    path.resolve(__dirname, <span class="string">"node_modules"</span>, <span class="string">"antd"</span>),</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.(png|jpg|gif|woff|woff2|eot|ttf|svg)$/i</span>,</span><br><span class="line">                use: [&#123;</span><br><span class="line">                    loader: <span class="string">'url-loader'</span>,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        limit: <span class="number">100000</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> HtmlWebPackPlugin(&#123;</span><br><span class="line">            template: path.join(__dirname, <span class="string">"src"</span>, <span class="string">"index.html"</span>),</span><br><span class="line">            filename: path.join(__dirname, <span class="string">"dist"</span>, <span class="string">"index.html"</span>)</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="keyword">new</span> webpack.HotModuleReplacementPlugin()</span><br><span class="line">    ],</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        port: <span class="number">4954</span>,</span><br><span class="line">        contentBase: <span class="string">"./dist"</span>,</span><br><span class="line">        historyApiFallback: <span class="literal">true</span>,</span><br><span class="line">        hot: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="index-jsx-入口文件"><a href="#index-jsx-入口文件" class="headerlink" title="index.jsx 入口文件"></a>index.jsx 入口文件</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">index.jsx</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dva <span class="keyword">from</span> <span class="string">"dva"</span>;</span><br><span class="line"><span class="keyword">import</span> routers <span class="keyword">from</span> <span class="string">'./config/Routers'</span></span><br><span class="line"><span class="keyword">import</span> history <span class="keyword">from</span> <span class="string">'./config/History'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// model</span></span><br><span class="line"><span class="keyword">import</span> BaseModel <span class="keyword">from</span> <span class="string">'./model/BaseModel'</span>;</span><br><span class="line"><span class="keyword">import</span> LoginModel <span class="keyword">from</span> <span class="string">'./model/LoginModel'</span></span><br><span class="line"><span class="keyword">import</span> SongListModel <span class="keyword">from</span> <span class="string">'./model/SongListModel'</span>;</span><br><span class="line"><span class="keyword">import</span> PlayListDetailModel <span class="keyword">from</span> <span class="string">'./model/PlayListDetailModel'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = dva(&#123;</span><br><span class="line">    history: history, <span class="comment">//自定义history,可以去除url上的_k和#之类的符号</span></span><br><span class="line">    onError(error) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(error.stack); <span class="comment">//同意的error处理</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入model层</span></span><br><span class="line">app.model(LoginModel)</span><br><span class="line">app.model(SongListModel)</span><br><span class="line">app.model(PlayListDetailModel)</span><br><span class="line">app.model(BaseModel)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入router</span></span><br><span class="line">app.router(routers)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义些全局变量</span></span><br><span class="line"><span class="built_in">window</span>.App_ = &#123;</span><br><span class="line">    history: history,</span><br><span class="line">    dva: app</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动,在class="root"</span></span><br><span class="line">app.start(<span class="string">"#root"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack service配置</span></span><br><span class="line"><span class="built_in">module</span>.hot.accept();</span><br></pre></td></tr></table></figure>
<h4 id="History-js"><a href="#History-js" class="headerlink" title="History.js"></a>History.js</h4><p><a href="https://github.com/brickspert/blog/issues/3" target="_blank" rel="noopener">History和Routers请参考</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">History.js</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> createHistory <span class="keyword">from</span> <span class="string">'history/createBrowserHistory'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> createHistory();</span><br></pre></td></tr></table></figure>
<h4 id="Routers-jsx"><a href="#Routers-jsx" class="headerlink" title="Routers.jsx"></a>Routers.jsx</h4><p>由于<code>router-v4</code>把<code>&lt;Route/&gt;</code>组件化,所以<code>router-v3</code>那种配置便不可用了.在<code>v4</code>中<code>&lt;Router/&gt;</code>可以当做子组件使用,具体参考<code>BaseLayout.jsx</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Routers.jsx</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Route, Router, Switch &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> BaseLayout <span class="keyword">from</span> <span class="string">'../layout/BaseLayout'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> history <span class="keyword">from</span> <span class="string">'./History'</span>;</span><br><span class="line"><span class="keyword">const</span> routers = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;Router history=&#123;history&#125;&gt;</span><br><span class="line">            &lt;Route path=<span class="string">"/"</span> component=&#123;BaseLayout&#125;&gt;</span><br><span class="line">            &lt;<span class="regexp">/Route&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Router&gt;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> routers</span><br></pre></td></tr></table></figure>
<h4 id="BaseLayout-jsx"><a href="#BaseLayout-jsx" class="headerlink" title="BaseLayout.jsx"></a>BaseLayout.jsx</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicLayout</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    push()&#123;</span><br><span class="line">        <span class="comment">// 这是跳转页面的方法,具体使用参考history库</span></span><br><span class="line">        <span class="comment">// App_.history是在index.jsx中定义的全局变量</span></span><br><span class="line">        App_.history.push(<span class="string">"/songList"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;Layout&gt;</span><br><span class="line">                &lt;Header&gt;</span><br><span class="line">                    Header</span><br><span class="line">                &lt;<span class="regexp">/Header&gt;</span></span><br><span class="line"><span class="regexp">                &lt;Content&gt;</span></span><br><span class="line"><span class="regexp">                    &lt;div&gt;</span></span><br><span class="line"><span class="regexp">                        &lt;Switch&gt;</span></span><br><span class="line"><span class="regexp">                            &lt;Route path="/</span>login<span class="string">" component=&#123;Login&#125;&gt;&lt;/Route&gt;</span></span><br><span class="line"><span class="string">                            &lt;Route path="</span>/songList<span class="string">" component=&#123;SongList&#125;&gt;&lt;/Route&gt;</span></span><br><span class="line"><span class="string">                            &lt;Route path="</span>/playListDetail<span class="string">" component=&#123;PlayListDetail&#125;&gt;</span></span><br><span class="line"><span class="string">                            &lt;/Route&gt;</span></span><br><span class="line"><span class="string">                        &lt;/Switch&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/Content&gt;</span></span><br><span class="line"><span class="string">                &lt;Footer style=&#123;&#123; textAlign: 'center', height: "</span><span class="number">150</span>px<span class="string">" &#125;&#125;&gt;</span></span><br><span class="line"><span class="string">                    Footer</span></span><br><span class="line"><span class="string">                &lt;/Footer&gt;</span></span><br><span class="line"><span class="string">            &lt;/Layout&gt;</span></span><br><span class="line"><span class="string">        )</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="model层案例"><a href="#model层案例" class="headerlink" title="model层案例"></a>model层案例</h4><p><code>namespace</code>是一个作用域,用于你查找对应<code>model</code>的数据:<br>使用<code>dvaJS</code>管理<code>state</code>后,会有一个<code>this.state</code>对象,所有的<code>state</code>都以<code>namespace</code>为<code>key</code>,整合到了<code>this.state</code>中.那么如何获取我对应<code>model</code>的<code>state</code>呢?<br>这个时候只要通过<code>this.state.[namespace]</code>就能获取到对应的<code>state</code>了,比如<code>this.state.songListNamespace</code>就能获取到下面<code>state</code>了.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    namespace: <span class="string">"songListNamespace"</span>, </span><br><span class="line">    state: &#123;</span><br><span class="line">        playlist: [],</span><br><span class="line">        loading: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    effects: &#123;</span><br><span class="line">        * getDataList(_, &#123;</span><br><span class="line">            call,</span><br><span class="line">            put,</span><br><span class="line">            select</span><br><span class="line">        &#125;) &#123;</span><br><span class="line">            <span class="comment">// call暂时不知道干嘛的,还没用过</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// select 用于获取state 例如:</span></span><br><span class="line">            <span class="comment">// const loading = yield select(state =&gt; state.songListNamespace.loading) 就是获取loading状态.PS:state是全局的,所以要加上namespace</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用接口</span></span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">yield</span> RecommendService.songList()</span><br><span class="line">            <span class="keyword">const</span> data = response.result</span><br><span class="line">            <span class="comment">// put 相当于一个动作,目的是调用下面reducers中的addData方法</span></span><br><span class="line">            <span class="keyword">yield</span> put(&#123;</span><br><span class="line">                type: <span class="string">"addData"</span>,</span><br><span class="line">                payload: &#123;</span><br><span class="line">                    data: data</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 展示下怎么传递参数到effects</span></span><br><span class="line">        * pushPlayListDetail(&#123;</span><br><span class="line">            payload <span class="comment">//传递的参数,里面也可以放回调函数,回调到view层</span></span><br><span class="line">        &#125;, &#123;</span><br><span class="line">            put</span><br><span class="line">        &#125;) &#123;</span><br><span class="line">            <span class="comment">// push带参数</span></span><br><span class="line">            App_.history.push(&#123;</span><br><span class="line">                pathname: <span class="string">'/playListDetail'</span>,</span><br><span class="line">                state: &#123;</span><br><span class="line">                    id: payload.id</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    reducers: &#123;</span><br><span class="line">        addData(state, action) &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                playlist: action.payload.data</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="上面model对应的view"><a href="#上面model对应的view" class="headerlink" title="上面model对应的view"></a>上面model对应的view</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; List, Avatar, Spin &#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">"dva"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 作用域</span></span><br><span class="line"><span class="keyword">const</span> namespace = <span class="string">"songListNamespace"</span></span><br><span class="line"><span class="comment">// 将state 转化为 this.props.songListData PS:只是使用方式上的转化</span></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> songListData = state[namespace]</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        songListData</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 定义的action,用于调用model中的effects中的方法.PS:需要指明作用域,可以跨域调用,state同理</span></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        getDataList: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            dispatch(&#123;</span><br><span class="line">                type: <span class="string">`<span class="subst">$&#123;namespace&#125;</span>/getDataList`</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">        onPushSongList: <span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">            dispatch(&#123;</span><br><span class="line">                type: <span class="string">`<span class="subst">$&#123;namespace&#125;</span>/pushPlayListDetail`</span>,</span><br><span class="line">                payload: &#123;</span><br><span class="line">                    id, id</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SongList</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    state = &#123;</span><br><span class="line">        playlist: [],</span><br><span class="line">        loading: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    componentDidMount() &#123;</span><br><span class="line">        <span class="comment">// 调用model中的getDataList方法,调用流程如下</span></span><br><span class="line">        <span class="comment">// 当前文件 mapDispatchToProps -&gt; getDataList -&gt; model -&gt; effects -&gt; getDataList</span></span><br><span class="line">        <span class="keyword">this</span>.props.getDataList()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;Spin tip=<span class="string">"加载数据,请稍等..."</span> spinning=&#123;<span class="keyword">this</span>.props.songListData.loading&#125; delay=<span class="string">"500"</span>&gt;</span><br><span class="line">                &lt;List</span><br><span class="line">                    itemLayout=<span class="string">"horizontal"</span></span><br><span class="line">                    dataSource=&#123;<span class="keyword">this</span>.props.songListData.playlist&#125;</span><br><span class="line">                    renderItem=&#123;(item) =&gt; (</span><br><span class="line">                        &lt;List.Item&gt;</span><br><span class="line">                            &lt;List.Item.Meta</span><br><span class="line">                                avatar=&#123;&lt;Avatar src=&#123;item.picUrl&#125; /&gt;&#125;</span><br><span class="line">                                title=&#123;&lt;span</span><br><span class="line">                                    onClick=&#123;() =&gt; &#123;</span><br><span class="line">                                        <span class="keyword">this</span>.props.onPushSongList(item.id)</span><br><span class="line">                                    &#125;&#125;</span><br><span class="line">&gt;&#123;item.name&#125;&lt;<span class="regexp">/span&gt;&#125;</span></span><br><span class="line"><span class="regexp">                                description=&#123;&lt;span&gt;&#123;item.copywriter&#125;&lt;/</span>span&gt;&#125;</span><br><span class="line">                            &gt;</span><br><span class="line">                            &lt;<span class="regexp">/List.Item.Meta&gt;</span></span><br><span class="line"><span class="regexp">                        &lt;/</span>List.Item&gt;</span><br><span class="line">                    )&#125;</span><br><span class="line">                /&gt;</span><br><span class="line">            &lt;<span class="regexp">/Spin&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 将mapStateToProps,mapDispatchToProps,SongList整合为一个整体</span></span><br><span class="line"><span class="regexp">export default connect(mapStateToProps, mapDispatchToProps)(SongList);</span></span><br></pre></td></tr></table></figure>
<p>const songListData = state[namespace]<br>    return {<br>        songListData<br>    }</p>
<h4 id="connect的方便写法"><a href="#connect的方便写法" class="headerlink" title="connect的方便写法"></a>connect的方便写法</h4><p>下面这种写法要通过<code>ES7</code>的装饰器才可以使用,上面<code>babel</code>中有介绍<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@connect(</span><br><span class="line">    _state =&gt; (&#123;</span><br><span class="line">        songListData: _state[namespace], <span class="comment">// 总的</span></span><br><span class="line">        playlist:_state[namespace].playlist, <span class="comment">//分开的</span></span><br><span class="line">        loading:_state[namespace].loading, <span class="comment">//分开的</span></span><br><span class="line">    &#125;),</span><br><span class="line">    _dispatch =&gt; (&#123;</span><br><span class="line">        getDataList: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            _dispatch(&#123;</span><br><span class="line">                type: <span class="string">`<span class="subst">$&#123;namespace&#125;</span>/getDataList`</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">        onPushSongList: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            _dispatch(&#123;</span><br><span class="line">                type: <span class="string">`<span class="subst">$&#123;namespace&#125;</span>/pushPlayListDetail`</span>,</span><br><span class="line">                payload: &#123;</span><br><span class="line">                    id, id</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;))</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SongList</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="comment">//使用</span></span><br><span class="line">    <span class="comment">// this.props.songListData </span></span><br><span class="line">    <span class="comment">// this.props.playlist </span></span><br><span class="line">    <span class="comment">// this.props.loading</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>前端的技术栈有点长,要慢慢的整理.现在我也只是简单使用,<code>dvaJs</code>更是入门.<br>接下来还有<code>react</code>的<code>PureComponent</code>,<code>无状态组件</code>,<code>生命周期</code>等等.<br><code>dva</code>的话还要了解<code>react-router/react-saga/react-redux</code>,等等.学习的路还很长啊.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/25/从源码学习UEToll–捕获控件梳理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="beilo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="beilo 技术小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/25/从源码学习UEToll–捕获控件梳理/" itemprop="url">react 网易云音乐项目小结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-25T10:56:34+08:00">
                2018-10-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="从源码学习UEToll–捕获控件梳理"><a href="#从源码学习UEToll–捕获控件梳理" class="headerlink" title="从源码学习UEToll–捕获控件梳理"></a>从源码学习UEToll–捕获控件梳理</h1><h2 id="捕获代码分析"><a href="#捕获代码分析" class="headerlink" title="捕获代码分析"></a>捕获代码分析</h2><h3 id="TransparentActivity"><a href="#TransparentActivity" class="headerlink" title="TransparentActivity"></a>TransparentActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Type &#123;</span><br><span class="line">    <span class="keyword">int</span> TYPE_UNKNOWN = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> TYPE_EDIT_ATTR = <span class="number">1</span>; <span class="comment">// 捕获控件</span></span><br><span class="line">    <span class="keyword">int</span> TYPE_SHOW_GRIDDING = <span class="number">2</span>; <span class="comment">// 网格</span></span><br><span class="line">    <span class="keyword">int</span> TYPE_RELATIVE_POSITION = <span class="number">3</span>; <span class="comment">// 相对位置</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="comment">/// 省略代码</span></span><br><span class="line">    type = getIntent().getIntExtra(EXTRA_TYPE, TYPE_UNKNOWN);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> TYPE_EDIT_ATTR: <span class="comment">// 捕获控件的入口</span></span><br><span class="line">            EditAttrLayout editAttrLayout = <span class="keyword">new</span> EditAttrLayout(<span class="keyword">this</span>);</span><br><span class="line">            editAttrLayout.setOnDragListener(<span class="keyword">new</span> EditAttrLayout.OnDragListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showOffset</span><span class="params">(String offsetContent)</span> </span>&#123;</span><br><span class="line">                    board.updateInfo(offsetContent); <span class="comment">//更新左下角展示的view描述</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            vContainer.addView(editAttrLayout);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="EditAttrLayout"><a href="#EditAttrLayout" class="headerlink" title="EditAttrLayout"></a>EditAttrLayout</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EditAttrLayout</span> <span class="keyword">extends</span> <span class="title">CollectViewsLayout</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Element targetElement;</span><br><span class="line">    <span class="keyword">private</span> AttrsDialog dialog;</span><br><span class="line">    <span class="keyword">private</span> IMode mode = <span class="keyword">new</span> ShowMode();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> lastX, lastY;</span><br><span class="line">    <span class="keyword">private</span> OnDragListener onDragListener;   </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line">        <span class="keyword">if</span> (targetElement != <span class="keyword">null</span>) &#123;</span><br><span class="line">            canvas.drawRect(targetElement.getRect(), areaPaint);</span><br><span class="line">            mode.onDraw(canvas); <span class="comment">// 进行mode的draw</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (event.getAction()) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                lastX = event.getX();</span><br><span class="line">                lastY = event.getY();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">                mode.triggerActionUp(event); <span class="comment">// 调用ShowMode.triggerActionUp(默认),可更改为MoveMode.triggerActionUp</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                mode.triggerActionMove(event); <span class="comment">// 移动view时触发的方法</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ShowMode</span> <span class="keyword">implements</span> <span class="title">IMode</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">            Rect rect = targetElement.getRect();</span><br><span class="line">            drawLineWithText(canvas, rect.left, rect.top - lineBorderDistance, rect.right, rect.top - lineBorderDistance);</span><br><span class="line">            drawLineWithText(canvas, rect.right + lineBorderDistance, rect.top, rect.right + lineBorderDistance, rect.bottom);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">triggerActionMove</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">triggerActionUp</span><span class="params">(<span class="keyword">final</span> MotionEvent event)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 在按下抬起的时候 获取到event,并生成element</span></span><br><span class="line">            <span class="keyword">final</span> Element element = getTargetElement(event.getX(), event.getY());</span><br><span class="line">            <span class="keyword">if</span> (element != <span class="keyword">null</span>) &#123;</span><br><span class="line">                targetElement = element; <span class="comment">// 赋值给当前元素</span></span><br><span class="line">                invalidate();  <span class="comment">// 请求重绘View树,即draw()过程</span></span><br><span class="line">                <span class="keyword">if</span> (dialog == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    dialog = <span class="keyword">new</span> AttrsDialog(getContext());</span><br><span class="line">                    dialog.setAttrDialogCallback(<span class="keyword">new</span> AttrsDialog.AttrDialogCallback() &#123;</span><br><span class="line">                        <span class="comment">// 里面的回调我们先不关心,现在只关心bottom弹出部分</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                dialog.show(targetElement); <span class="comment">// 弹出展示页面</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AttrsDialog"><a href="#AttrsDialog" class="headerlink" title="AttrsDialog"></a>AttrsDialog</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttrsDialog</span> <span class="keyword">extends</span> <span class="title">Dialog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> RecyclerView vList; <span class="comment">// bottom view</span></span><br><span class="line">    <span class="keyword">private</span> Adapter adapter = <span class="keyword">new</span> Adapter();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">        show(); <span class="comment">// Dialog.show()</span></span><br><span class="line">        <span class="comment">// ... 省略些window配置</span></span><br><span class="line">        adapter.notifyDataSetChanged(element); <span class="comment">// 更新bottom view </span></span><br><span class="line">        layoutManager.scrollToPosition(<span class="number">0</span>);</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里发现只是更新了<code>adapter</code>数据,那接下来就应该去<code>adapter</code>里面去找数据的来源了.<br><code>adapter</code>代码太多了了截取了相关代码进行展示</p>
<h3 id="AttrsDialog-Adapter"><a href="#AttrsDialog-Adapter" class="headerlink" title="AttrsDialog.Adapter"></a>AttrsDialog.Adapter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Item&gt; items = <span class="keyword">new</span> ItemArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> AttrDialogCallback callback;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新item数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyDataSetChanged</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">        items.clear();</span><br><span class="line">        <span class="keyword">for</span> (String attrsProvider : UETool.getInstance().getAttrsProvider()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                IAttrs attrs = (IAttrs) Class.forName(attrsProvider).newInstance();</span><br><span class="line">                items.addAll(attrs.getAttrs(element)); <span class="comment">// 这里获取的数据</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        notifyDataSetChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现数据都是通过<code>IAttrs.getAttrs(element)</code>获取的.接下来就<code>Ctrl+Alt+鼠标左键</code>找到了<code>UETCore</code>/<code>UETTextView</code>/<code>UETImageView</code>,<br>它们都实现了<code>IAttrs</code>类.由下面的代码就可以知道<code>item</code>的数据是从哪里来的了.</p>
<ol>
<li>先是获取到element的view</li>
<li>通过<code>AttrsManager.createAttrs(view)</code>获取自定义view的属性,并且进行填充</li>
<li>针对不同的属性填充不同的item,对应的值从view中获取</li>
<li>最后返回一个总属性的<code>List&lt;item&gt;</code></li>
</ol>
<h3 id="UETCore"><a href="#UETCore" class="headerlink" title="UETCore"></a>UETCore</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UETCore</span> <span class="keyword">implements</span> <span class="title">IAttrs</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Item&gt; <span class="title">getAttrs</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">        List&lt;Item&gt; items = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        View view = element.getView();</span><br><span class="line"></span><br><span class="line">        items.add(<span class="keyword">new</span> SwitchItem(<span class="string">"Move"</span>, element, SwitchItem.Type.TYPE_MOVE));</span><br><span class="line">        items.add(<span class="keyword">new</span> SwitchItem(<span class="string">"ValidViews"</span>, element, SwitchItem.Type.TYPE_SHOW_VALID_VIEWS));</span><br><span class="line"></span><br><span class="line">        IAttrs iAttrs = AttrsManager.createAttrs(view);</span><br><span class="line">        <span class="keyword">if</span> (iAttrs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            items.addAll(iAttrs.getAttrs(element));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        items.add(<span class="keyword">new</span> TitleItem(<span class="string">"COMMON"</span>));</span><br><span class="line">        items.add(<span class="keyword">new</span> TextItem(<span class="string">"Class"</span>, view.getClass().getName()));</span><br><span class="line">        items.add(<span class="keyword">new</span> TextItem(<span class="string">"Id"</span>, Util.getResId(view)));</span><br><span class="line">        items.add(<span class="keyword">new</span> TextItem(<span class="string">"ResName"</span>, Util.getResourceName(view.getId())));</span><br><span class="line">        items.add(<span class="keyword">new</span> TextItem(<span class="string">"Clickable"</span>, Boolean.toString(view.isClickable()).toUpperCase()));</span><br><span class="line">        items.add(<span class="keyword">new</span> TextItem(<span class="string">"Focused"</span>, Boolean.toString(view.isFocused()).toUpperCase()));</span><br><span class="line">        items.add(<span class="keyword">new</span> AddMinusEditItem(<span class="string">"Width（dp）"</span>, element, EditTextItem.Type.TYPE_WIDTH, px2dip(view.getWidth())));</span><br><span class="line">        items.add(<span class="keyword">new</span> AddMinusEditItem(<span class="string">"Height（dp）"</span>, element, EditTextItem.Type.TYPE_HEIGHT, px2dip(view.getHeight())));</span><br><span class="line">        items.add(<span class="keyword">new</span> TextItem(<span class="string">"Alpha"</span>, String.valueOf(view.getAlpha())));</span><br><span class="line">        Object background = Util.getBackground(view);</span><br><span class="line">        <span class="keyword">if</span> (background <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            items.add(<span class="keyword">new</span> TextItem(<span class="string">"Background"</span>, (String) background));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (background <span class="keyword">instanceof</span> Bitmap) &#123;</span><br><span class="line">            items.add(<span class="keyword">new</span> BitmapItem(<span class="string">"Background"</span>, (Bitmap) background));</span><br><span class="line">        &#125;</span><br><span class="line">        items.add(<span class="keyword">new</span> AddMinusEditItem(<span class="string">"PaddingLeft（dp）"</span>, element, EditTextItem.Type.TYPE_PADDING_LEFT, px2dip(view.getPaddingLeft())));</span><br><span class="line">        items.add(<span class="keyword">new</span> AddMinusEditItem(<span class="string">"PaddingRight（dp）"</span>, element, EditTextItem.Type.TYPE_PADDING_RIGHT, px2dip(view.getPaddingRight())));</span><br><span class="line">        items.add(<span class="keyword">new</span> AddMinusEditItem(<span class="string">"PaddingTop（dp）"</span>, element, EditTextItem.Type.TYPE_PADDING_TOP, px2dip(view.getPaddingTop())));</span><br><span class="line">        items.add(<span class="keyword">new</span> AddMinusEditItem(<span class="string">"PaddingBottom（dp）"</span>, element, EditTextItem.Type.TYPE_PADDING_BOTTOM, px2dip(view.getPaddingBottom())));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> items;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AttrsManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IAttrs <span class="title">createAttrs</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (view <span class="keyword">instanceof</span> TextView) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> UETTextView();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (view <span class="keyword">instanceof</span> ImageView) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> UETImageView();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UETTextView</span> <span class="keyword">implements</span> <span class="title">IAttrs</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;Item&gt; <span class="title">getAttrs</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">            List&lt;Item&gt; items = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            TextView textView = ((TextView) element.getView());</span><br><span class="line">            items.add(<span class="keyword">new</span> TitleItem(<span class="string">"TextView"</span>));</span><br><span class="line">            items.add(<span class="keyword">new</span> EditTextItem(<span class="string">"Text"</span>, element, EditTextItem.Type.TYPE_TEXT, textView.getText().toString()));</span><br><span class="line">            items.add(<span class="keyword">new</span> AddMinusEditItem(<span class="string">"TextSize（sp）"</span>, element, EditTextItem.Type.TYPE_TEXT_SIZE, px2sp(textView.getTextSize())));</span><br><span class="line">            items.add(<span class="keyword">new</span> EditTextItem(<span class="string">"TextColor"</span>, element, EditTextItem.Type.TYPE_TEXT_COLOR, Util.intToHexColor(textView.getCurrentTextColor())));</span><br><span class="line">            List&lt;Pair&lt;String, Bitmap&gt;&gt; pairs = Util.getTextViewBitmap(textView);</span><br><span class="line">            <span class="keyword">for</span> (Pair&lt;String, Bitmap&gt; pair : pairs) &#123;</span><br><span class="line">                items.add(<span class="keyword">new</span> BitmapItem(pair.first, pair.second));</span><br><span class="line">            &#125;</span><br><span class="line">            items.add(<span class="keyword">new</span> SwitchItem(<span class="string">"IsBold"</span>, element, SwitchItem.Type.TYPE_IS_BOLD, textView.getTypeface() != <span class="keyword">null</span> ? textView.getTypeface().isBold() : <span class="keyword">false</span>));</span><br><span class="line">            <span class="keyword">return</span> items;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UETImageView</span> <span class="keyword">implements</span> <span class="title">IAttrs</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;Item&gt; <span class="title">getAttrs</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">            List&lt;Item&gt; items = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            ImageView imageView = ((ImageView) element.getView());</span><br><span class="line">            items.add(<span class="keyword">new</span> TitleItem(<span class="string">"ImageView"</span>));</span><br><span class="line">            items.add(<span class="keyword">new</span> BitmapItem(<span class="string">"Bitmap"</span>, Util.getImageViewBitmap(imageView)));</span><br><span class="line">            items.add(<span class="keyword">new</span> TextItem(<span class="string">"ScaleType"</span>, Util.getImageViewScaleType(imageView)));</span><br><span class="line">            <span class="keyword">return</span> items;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么<code>element</code>从哪里来的呢<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AttrsDialog</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">    show();</span><br><span class="line">    Window dialogWindow = getWindow();</span><br><span class="line">    WindowManager.LayoutParams lp = dialogWindow.getAttributes();</span><br><span class="line">    dialogWindow.setGravity(Gravity.LEFT | Gravity.TOP);</span><br><span class="line">    lp.x = element.getRect().left;</span><br><span class="line">    lp.y = element.getRect().bottom;</span><br><span class="line">    lp.width = getScreenWidth() - dip2px(<span class="number">30</span>);</span><br><span class="line">    lp.height = getScreenHeight() / <span class="number">2</span>;</span><br><span class="line">    dialogWindow.setAttributes(lp);</span><br><span class="line">    adapter.notifyDataSetChanged(element); <span class="comment">//这里传递给adapter的</span></span><br><span class="line">    layoutManager.scrollToPosition(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EditAttrLayout.ShowMode </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">triggerActionUp</span><span class="params">(<span class="keyword">final</span> MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Element element = getTargetElement(event.getX(), event.getY());</span><br><span class="line">    <span class="keyword">if</span> (element != <span class="keyword">null</span>) &#123;</span><br><span class="line">        targetElement = element;</span><br><span class="line">        invalidate();</span><br><span class="line">        <span class="keyword">if</span> (dialog == <span class="keyword">null</span>) &#123;</span><br><span class="line">            dialog = <span class="keyword">new</span> AttrsDialog(getContext());</span><br><span class="line">            dialog.setAttrDialogCallback(<span class="keyword">new</span> AttrsDialog.AttrDialogCallback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enableMove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    mode = <span class="keyword">new</span> MoveMode();</span><br><span class="line">                    dialog.dismiss();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showValidViews</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">boolean</span> isChecked)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">int</span> positionStart = position + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">if</span> (isChecked) &#123;</span><br><span class="line">                        dialog.notifyValidViewItemInserted(positionStart, getTargetElements(lastX, lastY), targetElement);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        dialog.notifyItemRangeRemoved(positionStart);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectView</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">                    targetElement = element;</span><br><span class="line">                    dialog.dismiss();</span><br><span class="line">                    dialog.show(targetElement);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            dialog.setOnDismissListener(<span class="keyword">new</span> DialogInterface.OnDismissListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDismiss</span><span class="params">(DialogInterface dialog)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (targetElement != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        targetElement.reset();</span><br><span class="line">                        invalidate();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        dialog.show(targetElement);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>就会发现重点在<code>getTargetElement</code>方法里面,所有更新<code>adapter</code>的操作都走了这个方法.<br>跟踪上去<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Element <span class="title">getTargetElement</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y)</span> </span>&#123;</span><br><span class="line">    Element target = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = elements.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">final</span> Element element = elements.get(i);</span><br><span class="line">        <span class="keyword">if</span> (element.getRect().contains((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isParentNotVisible(element.getParentElement())) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (element != childElement) &#123;</span><br><span class="line">                childElement = element;</span><br><span class="line">                parentElement = element;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parentElement != <span class="keyword">null</span>) &#123;</span><br><span class="line">                parentElement = parentElement.getParentElement();</span><br><span class="line">            &#125;</span><br><span class="line">            target = parentElement;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Toast.makeText(getContext(), getResources().getString(R.string.uet_target_element_not_found, x, y), Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>发现跟<code>elements</code>这个数组有关系<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CollectViewsLayout</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">traverse</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UETool.getInstance().getFilterClasses().contains(view.getClass().getName())) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (view.getAlpha() == <span class="number">0</span> || view.getVisibility() != View.VISIBLE) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (getResources().getString(R.string.uet_disable).equals(view.getTag())) <span class="keyword">return</span>;</span><br><span class="line">    elements.add(<span class="keyword">new</span> Element(view));</span><br><span class="line">    <span class="keyword">if</span> (view <span class="keyword">instanceof</span> ViewGroup) &#123;</span><br><span class="line">        ViewGroup parent = (ViewGroup) view;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parent.getChildCount(); i++) &#123;</span><br><span class="line">            traverse(parent.getChildAt(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onAttachedToWindow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onAttachedToWindow();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Activity targetActivity = UETool.getInstance().getTargetActivity();</span><br><span class="line">        WindowManager windowManager = targetActivity.getWindowManager();</span><br><span class="line">        Field mGlobalField = Class.forName(<span class="string">"android.view.WindowManagerImpl"</span>).getDeclaredField(<span class="string">"mGlobal"</span>);</span><br><span class="line">        mGlobalField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">            Field mViewsField = Class.forName(<span class="string">"android.view.WindowManagerGlobal"</span>).getDeclaredField(<span class="string">"mViews"</span>);</span><br><span class="line">            mViewsField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            List&lt;View&gt; views = (List&lt;View&gt;) mViewsField.get(mGlobalField.get(windowManager));</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = views.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                View targetView = getTargetDecorView(targetActivity, views.get(i));</span><br><span class="line">                <span class="keyword">if</span> (targetView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    traverse(targetView);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Field mRootsField = Class.forName(<span class="string">"android.view.WindowManagerGlobal"</span>).getDeclaredField(<span class="string">"mRoots"</span>);</span><br><span class="line">            mRootsField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            List viewRootImpls;</span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">                viewRootImpls = (List) mRootsField.get(mGlobalField.get(windowManager));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                viewRootImpls = Arrays.asList((Object[]) mRootsField.get(mGlobalField.get(windowManager)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = viewRootImpls.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                Class clazz = Class.forName(<span class="string">"android.view.ViewRootImpl"</span>);</span><br><span class="line">                Object object = viewRootImpls.get(i);</span><br><span class="line">                Field mWindowAttributesField = clazz.getDeclaredField(<span class="string">"mWindowAttributes"</span>);</span><br><span class="line">                mWindowAttributesField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                Field mViewField = clazz.getDeclaredField(<span class="string">"mView"</span>);</span><br><span class="line">                mViewField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                View decorView = (View) mViewField.get(object);</span><br><span class="line">                WindowManager.LayoutParams layoutParams = (WindowManager.LayoutParams) mWindowAttributesField.get(object);</span><br><span class="line">                <span class="keyword">if</span> (layoutParams.getTitle().toString().contains(targetActivity.getClass().getName())</span><br><span class="line">                        || getTargetDecorView(targetActivity, decorView) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    traverse(decorView);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>发现这个方法通过<code>反射</code>获取到应用的<code>mViews</code>,然后循环找到当前<code>Activity</code>的<code>decorView</code>,<br>然后递归<code>traverse</code>方法获取到所有的子<code>view</code>,填充到<code>elements</code>中,最后被<code>getTargetElement</code>获取出来.<br>然后基本上就这样了.</p>
<h2 id="总结-流程"><a href="#总结-流程" class="headerlink" title="总结-流程"></a>总结-流程</h2><ol>
<li><code>UETMenu.show()</code>在<code>window</code>层面展示一个悬浮框</li>
<li>点击第一个按钮<code>捕获控件</code>,跳转到<code>TransparentActivity</code></li>
<li>根据<code>type</code>在<code>Activity</code>的<code>vContainer</code>添加<code>EditAttrLayout</code></li>
<li>在<code>EditAttrLayout</code>的<code>MotionEvent.ACTION_UP</code>事件触发的时候就执行<code>ShowModel</code>的<code>triggerActionUp</code>,弹出<code>AttrsDialog</code>,用于展示相关<code>View</code>的信息</li>
<li><code>View</code>的详细信息在<code>UETCore</code>中获取</li>
<li>这时候注意到<code>adapter</code>的<code>items</code>的数据是由<code>show(element)</code>传递进来的</li>
<li><code>show</code>的<code>element</code>是<code>getTargetElement()</code>方法提供的</li>
<li><code>getTargetElement</code>中可以看到有个<code>elements</code>,再找到他的源头<code>-&gt;traverse-&gt;onAttachedToWindow</code></li>
</ol>
<p>捕获代码并且展示的这一部分就差不多了.大致流程应该梳理的还算清楚了.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/19/LeakCanary-理解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="beilo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="beilo 技术小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/19/LeakCanary-理解/" itemprop="url">LeakCanary 理解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-19T15:53:14+08:00">
                2018-09-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/16/IntentService-理解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="beilo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="beilo 技术小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/16/IntentService-理解/" itemprop="url">IntentService 理解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-16T14:49:19+08:00">
                2018-08-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="IntentService"><a href="#IntentService" class="headerlink" title="IntentService"></a>IntentService</h1><p><strong>IntentService用于需要执行异步操作的Service,当异步操作执行完毕时会停止这个Service</strong></p>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">public abstract class IntentService extends Service &#123;</span><br><span class="line">    private volatile Looper mServiceLooper; // 工作线程 looper</span><br><span class="line">    private volatile ServiceHandler mServiceHandler; // 工作handler</span><br><span class="line">    private String mName;</span><br><span class="line">    private boolean mRedelivery; // 恢复类型</span><br><span class="line"></span><br><span class="line">    private final class ServiceHandler extends Handler &#123;</span><br><span class="line">        public ServiceHandler(Looper looper) &#123;</span><br><span class="line">            super(looper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void handleMessage(Message msg) &#123;</span><br><span class="line">            onHandleIntent((Intent)msg.obj); // 消息不处理 直接发送过去</span><br><span class="line">            stopSelf(msg.arg1); //上面的方法执行完毕,停止这个service</span><br><span class="line">            // 由上可知,onHandleIntent方法中不能再写异步方法,否则可能直接停止service</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public IntentService(String name) &#123;</span><br><span class="line">        super();</span><br><span class="line">        mName = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setIntentRedelivery(boolean enabled) &#123;</span><br><span class="line">        mRedelivery = enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate() &#123;</span><br><span class="line">        super.onCreate();</span><br><span class="line">        // thread中使用handler必须要有looper,HandlerThread就是简化创建thread和looper关系</span><br><span class="line">        HandlerThread thread = new HandlerThread(&quot;IntentService[&quot; + mName + &quot;]&quot;);</span><br><span class="line">        thread.start(); // 创建循环looper,创建成功后会notifyAll();</span><br><span class="line"></span><br><span class="line">        mServiceLooper = thread.getLooper(); // 获取looper,当looper==null时wait(),等待start创建成功后的notifyAll再返回looper</span><br><span class="line">        mServiceHandler = new ServiceHandler(mServiceLooper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onStart(@Nullable Intent intent, int startId) &#123;</span><br><span class="line">         // onStart时给handler发送msg</span><br><span class="line">        Message msg = mServiceHandler.obtainMessage();</span><br><span class="line">        msg.arg1 = startId;</span><br><span class="line">        msg.obj = intent;</span><br><span class="line">        mServiceHandler.sendMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int onStartCommand(@Nullable Intent intent, int flags, int startId) &#123;</span><br><span class="line">        // 第一步调用onStart</span><br><span class="line">        // 第二步设置恢复模式</span><br><span class="line">        onStart(intent, startId);</span><br><span class="line">        return mRedelivery ? START_REDELIVER_INTENT : START_NOT_STICKY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onDestroy() &#123;</span><br><span class="line">        // 关闭looper,相当于不循环取消息了.这一套流程也就停止了.</span><br><span class="line">        mServiceLooper.quit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    @Nullable</span><br><span class="line">    public IBinder onBind(Intent intent) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @WorkerThread</span><br><span class="line">    protected abstract void onHandleIntent(@Nullable Intent intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IntentService-onCreate"><a href="#IntentService-onCreate" class="headerlink" title="IntentService$onCreate"></a>IntentService$onCreate</h3><ol>
<li>创建一个<code>HandlerThread</code>,并且<code>name</code>为<code>&quot;IntentService[&quot; + mName + &quot;]&quot;</code></li>
<li>调用<code>HandlerThread.start</code>,<ol>
<li>执行了<code>HandlerThread</code>中的<code>run</code>方法</li>
<li><code>looper</code>创建成功后会<code>notifyAll()</code></li>
<li>执行循环<code>looper</code></li>
</ol>
</li>
<li>ServiceHandler(thread.getLooper())<ol>
<li><code>getLooper</code>中,当<code>thread</code>活着 &amp;&amp; <code>mLooper==null</code>时,<code>wait()</code></li>
<li><code>wait()</code>是为了等待<code>looper</code>创建成功,执行<code>notifyAll()</code>,这样<code>mLooper</code>就有值了.</li>
</ol>
</li>
</ol>
<h3 id="IntentService-onStartCommand"><a href="#IntentService-onStartCommand" class="headerlink" title="IntentService$onStartCommand"></a>IntentService$onStartCommand</h3><ol>
<li>调用<code>onStart</code></li>
<li><code>handler.sendMessage(msg)</code></li>
<li><code>ServiceHandler$handleMessage</code></li>
<li><code>onDestroy</code>调用<code>looper.quit</code></li>
</ol>
<h3 id="ServiceHandler-handleMessage"><a href="#ServiceHandler-handleMessage" class="headerlink" title="ServiceHandler$handleMessage"></a>ServiceHandler$handleMessage</h3><p><code>onHandleIntent</code>中不能做异步处理,否则会直接执行<code>stopSelf</code></p>
<h3 id="onStartCommand的恢复模式"><a href="#onStartCommand的恢复模式" class="headerlink" title="onStartCommand的恢复模式"></a>onStartCommand的恢复模式</h3><ul>
<li><code>START_REDELIVER_INTENT</code>: 当service在启动时被杀死,将会被重新启动,知道service调用<code>stopSelf</code></li>
<li><code>START_NOT_STICKY</code>: 当service在启动时被杀死,不做处理.</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/13/RecyclerView-缓存/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="beilo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="beilo 技术小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/13/RecyclerView-缓存/" itemprop="url">RecyclerView 缓存</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-13T14:18:59+08:00">
                2018-08-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><h2 id="初始代码分析-getViewForPosition"><a href="#初始代码分析-getViewForPosition" class="headerlink" title="初始代码分析 getViewForPosition"></a>初始代码分析 getViewForPosition</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">View getViewForPosition(int position, boolean dryRun) &#123;</span><br><span class="line">    return tryGetViewHolderForPositionByDeadline(position, dryRun, FOREVER_NS).itemView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Nullable</span><br><span class="line">ViewHolder tryGetViewHolderForPositionByDeadline(int position,</span><br><span class="line">                boolean dryRun, long deadlineNs) &#123;</span><br><span class="line">    ViewHolder holder = null;</span><br><span class="line">    </span><br><span class="line">    1. 从mChangedScrap缓存中获取ViewHodler</span><br><span class="line">    if (mState.isPreLayout()) &#123;</span><br><span class="line">        holder = getChangedScrapViewForPosition(position);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    1. 从mAttachedScrap取出hiddden但是没有removed的view / mCachedViews取出viewHold </span><br><span class="line">    通过position</span><br><span class="line">    if (holder == null) &#123;</span><br><span class="line">        holder = getScrapOrHiddenOrCachedHolderForPosition(position, dryRun);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (holder == null) &#123;</span><br><span class="line">        final int type = mAdapter.getItemViewType(offsetPosition);</span><br><span class="line">        if (mAdapter.hasStableIds()) &#123;</span><br><span class="line">            1. 从mAttachedScrap  mCachedViews 取出viewhodler </span><br><span class="line">            通过id position的检索成本比id低</span><br><span class="line">            holder = getScrapOrCachedViewForId(mAdapter.getItemId(offsetPosition),</span><br><span class="line">                    type, dryRun);</span><br><span class="line">        &#125;</span><br><span class="line">        if (holder == null &amp;&amp; mViewCacheExtension != null) &#123;</span><br><span class="line">            1. mViewCacheExtension.getViewForPositionAndType获取view 取出viewhodler</span><br><span class="line">            final View view = mViewCacheExtension</span><br><span class="line">                    .getViewForPositionAndType(this, position, type);</span><br><span class="line">            if (view != null) &#123;</span><br><span class="line">                4.1 取出对应view的viewHolder</span><br><span class="line">                holder = getChildViewHolder(view);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (holder == null) &#123; </span><br><span class="line">            1. 从RecycledViewPool中取出对应type的viewholder</span><br><span class="line">            holder = getRecycledViewPool().getRecycledView(type);</span><br><span class="line">        &#125;</span><br><span class="line">        if (holder == null) &#123;</span><br><span class="line">            1. mAdapter.createViewHolder</span><br><span class="line">            holder = mAdapter.createViewHolder(RecyclerView.this, type);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    boolean bound = false;</span><br><span class="line">    if (mState.isPreLayout() &amp;&amp; holder.isBound()) &#123;</span><br><span class="line">        // do not update unless we absolutely have to.</span><br><span class="line">        holder.mPreLayoutPosition = position;</span><br><span class="line">    &#125; else if (!holder.isBound() || holder.needsUpdate() || holder.isInvalid()) &#123;</span><br><span class="line">        final int offsetPosition = mAdapterHelper.findPositionOffset(position);</span><br><span class="line">        1. bindViewHolder</span><br><span class="line">        bound = tryBindViewHolderByDeadline(holder, offsetPosition, position, deadlineNs);</span><br><span class="line">    &#125;</span><br><span class="line">    return holder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由上面的代码可以发现执行的先后顺序如下:</p>
<ol>
<li>从<code>mChangedScrap</code>缓存中获取<code>ViewHolder</code>。</li>
<li>通过<code>position</code>，从<code>mAttachedScrap</code>或者<code>mCachedViews中</code>取出<code>ViewHolder</code>。</li>
<li>通过<code>id</code>，从<code>mAttachedScrap</code>或者<code>mCachedViews中</code>取出<code>ViewHolder</code>。</li>
<li>通过<code>mViewCacheExtension</code>获取到<code>view</code>，然后取出对应view的ViewHolder。</li>
<li>从<code>mRecyclerPool</code>中取出对应<code>type</code>的<code>ViewHodler</code>。</li>
<li>调用<code>mAdapter.createViewHolder</code>。</li>
<li>当<code>!holder.isBound() || holder.needsUpdate() || holder.isInvalid()</code>，也就是<code>holder</code>不在范围内或者需要更新或者已经无效时，调用<code>bindViewHolder</code>，否则不更新。</li>
</ol>
<h2 id="RecycleView的四级缓存"><a href="#RecycleView的四级缓存" class="headerlink" title="RecycleView的四级缓存"></a>RecycleView的四级缓存</h2><ol>
<li>由<code>mChangedScrap</code>和<code>mAttachedScrap</code>组成的一级缓存,管理数据已经变化和没有分离的<code>ViewHolder</code>列表. (屏幕内缓存)</li>
<li>由<code>mCachedViews</code>组成的二级缓存,大小由<code>mViewCacheMax</code>决定,默认为2. (屏幕外缓存)</li>
<li><code>ViewCacheExtension</code>实现自定义缓存.(自定义缓存)</li>
<li><code>ViewHolder</code>在首先会缓存在<code>mCachedViews</code>中，当超过了个数（比如默认为2）， 就会添加到<code>RecycledViewPool</code>中。<code>RecycledViewPool</code>会根据每个<code>ViewType</code>把<code>ViewHolder</code>分别存储在不同的列表中，每个<code>ViewType</code>最多缓存<code>DEFAULT_MAX_SCRAP = 5</code>个<code>ViewHolder</code>，如果<code>RecycledViewPool</code>没有被多个<code>RecycledView</code>共享，对于线性布局，每个<code>ViewType</code>最多只有一个缓存，如果是网格有多少行就缓存多少个。(缓存池)</li>
</ol>
<h3 id="一级缓存"><a href="#一级缓存" class="headerlink" title="一级缓存"></a>一级缓存</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">getChangedScrapViewForPosition,</span><br><span class="line">getScrapOrHiddenOrCachedHolderForPosition,</span><br><span class="line">getScrapOrCachedViewForId,</span><br><span class="line"></span><br><span class="line">ViewHolder getChangedScrapViewForPosition(int position) &#123;</span><br><span class="line">    final int changedScrapSize;</span><br><span class="line">    if (mChangedScrap == null || (changedScrapSize = mChangedScrap.size()) == 0) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    通过position找到mChangedScrap中没有添加FLAG_RETURNED_FROM_SCRAP的holder</span><br><span class="line">    for (int i = 0; i &lt; changedScrapSize; i++) &#123;</span><br><span class="line">        final ViewHolder holder = mChangedScrap.get(i);</span><br><span class="line">        if (!holder.wasReturnedFromScrap() &amp;&amp; holder.getLayoutPosition() == position) &#123;</span><br><span class="line">            holder.addFlags(ViewHolder.FLAG_RETURNED_FROM_SCRAP);</span><br><span class="line">            return holder;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    通过id找到mChangedScrap中没有添加FLAG_RETURNED_FROM_SCRAP的holder</span><br><span class="line">    if (mAdapter.hasStableIds()) &#123;</span><br><span class="line">        final int offsetPosition = mAdapterHelper.findPositionOffset(position);</span><br><span class="line">        if (offsetPosition &gt; 0 &amp;&amp; offsetPosition &lt; mAdapter.getItemCount()) &#123;</span><br><span class="line">            final long id = mAdapter.getItemId(offsetPosition);</span><br><span class="line">            for (int i = 0; i &lt; changedScrapSize; i++) &#123;</span><br><span class="line">                final ViewHolder holder = mChangedScrap.get(i);</span><br><span class="line">                if (!holder.wasReturnedFromScrap() &amp;&amp; holder.getItemId() == id) &#123;</span><br><span class="line">                    holder.addFlags(ViewHolder.FLAG_RETURNED_FROM_SCRAP);</span><br><span class="line">                    return holder;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ViewHolder getScrapOrHiddenOrCachedHolderForPosition(int position, boolean dryRun) &#123;</span><br><span class="line">    final int scrapCount = mAttachedScrap.size();</span><br><span class="line">    从 mAttachedScrap中获取到 ViewHolder,通过position</span><br><span class="line">    for (int i = 0; i &lt; scrapCount; i++) &#123;</span><br><span class="line">        final ViewHolder holder = mAttachedScrap.get(i);</span><br><span class="line">        if (!holder.wasReturnedFromScrap() &amp;&amp; holder.getLayoutPosition() == position</span><br><span class="line">                &amp;&amp; !holder.isInvalid() &amp;&amp; (mState.mInPreLayout || !holder.isRemoved())) &#123;</span><br><span class="line">            holder.addFlags(ViewHolder.FLAG_RETURNED_FROM_SCRAP);</span><br><span class="line">            return holder;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!dryRun) &#123;</span><br><span class="line">        取出hiddden但是没有removed的view</span><br><span class="line">        View view = mChildHelper.findHiddenNonRemovedView(position);</span><br><span class="line">        if (view != null) &#123;</span><br><span class="line">            final ViewHolder vh = getChildViewHolderInt(view);</span><br><span class="line">            mChildHelper.unhide(view);</span><br><span class="line">            int layoutIndex = mChildHelper.indexOfChild(view);</span><br><span class="line">            if (layoutIndex == RecyclerView.NO_POSITION) &#123;</span><br><span class="line">                throw new IllegalStateException(&quot;layout index should not be -1 after &quot;</span><br><span class="line">                        + &quot;unhiding a view:&quot; + vh + exceptionLabel());</span><br><span class="line">            &#125;</span><br><span class="line">            mChildHelper.detachViewFromParent(layoutIndex);</span><br><span class="line">            scrapView(view);</span><br><span class="line">            vh.addFlags(ViewHolder.FLAG_RETURNED_FROM_SCRAP</span><br><span class="line">                    | ViewHolder.FLAG_BOUNCED_FROM_HIDDEN_LIST);</span><br><span class="line">            return vh;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ViewHolder getScrapOrCachedViewForId(long id, int type, boolean dryRun) &#123;</span><br><span class="line">    从mAttachedScrap中通过匹配id获取holder缓存。</span><br><span class="line">    final int count = mAttachedScrap.size();</span><br><span class="line">    for (int i = count - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">        final ViewHolder holder = mAttachedScrap.get(i);</span><br><span class="line">        if (holder.getItemId() == id &amp;&amp; !holder.wasReturnedFromScrap()) &#123;</span><br><span class="line">            if (type == holder.getItemViewType()) &#123;</span><br><span class="line">                holder.addFlags(ViewHolder.FLAG_RETURNED_FROM_SCRAP);</span><br><span class="line">                if (holder.isRemoved()) &#123;</span><br><span class="line">                    if (!mState.isPreLayout()) &#123;</span><br><span class="line">                        holder.setFlags(ViewHolder.FLAG_UPDATE, ViewHolder.FLAG_UPDATE</span><br><span class="line">                                | ViewHolder.FLAG_INVALID | ViewHolder.FLAG_REMOVED);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                return holder;</span><br><span class="line">            &#125; else if (!dryRun) &#123;</span><br><span class="line">                mAttachedScrap.remove(i);</span><br><span class="line">                removeDetachedView(holder.itemView, false);</span><br><span class="line">                quickRecycleScrapView(holder.itemView);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">getScrapOrHiddenOrCachedHolderForPosition</span><br><span class="line">getScrapOrCachedViewForId</span><br><span class="line"></span><br><span class="line">ViewHolder getScrapOrHiddenOrCachedHolderForPosition(int position, boolean dryRun) &#123;</span><br><span class="line">    从mCachedViews取出ViewHodler,通过position</span><br><span class="line">    final int cacheSize = mCachedViews.size();</span><br><span class="line">    for (int i = 0; i &lt; cacheSize; i++) &#123;</span><br><span class="line">        final ViewHolder holder = mCachedViews.get(i);</span><br><span class="line">        holder有效,则移出一级缓存</span><br><span class="line">        if (!holder.isInvalid() &amp;&amp; holder.getLayoutPosition() == position) &#123;</span><br><span class="line">            if (!dryRun) &#123;</span><br><span class="line">                mCachedViews.remove(i);</span><br><span class="line">            &#125;</span><br><span class="line">            return holder;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ViewHolder getScrapOrCachedViewForId(long id, int type, boolean dryRun) &#123;</span><br><span class="line">    从mCachedViews中通过匹配id获取holder缓存。 </span><br><span class="line">    final int cacheSize = mCachedViews.size();</span><br><span class="line">    for (int i = cacheSize - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">        final ViewHolder holder = mCachedViews.get(i);</span><br><span class="line">        if (holder.getItemId() == id) &#123;</span><br><span class="line">            if (type == holder.getItemViewType()) &#123;</span><br><span class="line">                if (!dryRun) &#123;</span><br><span class="line">                    mCachedViews.remove(i);</span><br><span class="line">                &#125;</span><br><span class="line">                return holder;</span><br><span class="line">            &#125; else if (!dryRun) &#123;</span><br><span class="line">                recycleCachedViewAt(i);</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="三级缓存"><a href="#三级缓存" class="headerlink" title="三级缓存"></a>三级缓存</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mViewCacheExtension.getViewForPositionAndType</span><br><span class="line"></span><br><span class="line">public abstract static class ViewCacheExtension &#123;</span><br><span class="line">    public abstract View getViewForPositionAndType(Recycler recycler, int position, int type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="四级缓存"><a href="#四级缓存" class="headerlink" title="四级缓存"></a>四级缓存</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">getRecycledViewPool().getRecycledView(type)</span><br><span class="line"></span><br><span class="line">static class ScrapData &#123;</span><br><span class="line">    ArrayList&lt;ViewHolder&gt; mScrapHeap = new ArrayList&lt;&gt;();</span><br><span class="line">    int mMaxScrap = DEFAULT_MAX_SCRAP;</span><br><span class="line">    long mCreateRunningAverageNs = 0;</span><br><span class="line">    long mBindRunningAverageNs = 0;</span><br><span class="line">&#125;</span><br><span class="line">SparseArray&lt;ScrapData&gt; mScrap = new SparseArray&lt;&gt;();</span><br><span class="line"></span><br><span class="line">public ViewHolder getRecycledView(int viewType) &#123;</span><br><span class="line">    RecycledViewPool是根据viewType获取ViewHolder,返回列表最后一个</span><br><span class="line">    final ScrapData scrapData = mScrap.get(viewType);</span><br><span class="line">    if (scrapData != null &amp;&amp; !scrapData.mScrapHeap.isEmpty()) &#123;</span><br><span class="line">        final ArrayList&lt;ViewHolder&gt; scrapHeap = scrapData.mScrapHeap;</span><br><span class="line">        返回列表最后一个</span><br><span class="line">        return scrapHeap.remove(scrapHeap.size() - 1);</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/13/logcat库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="beilo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="beilo 技术小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/13/logcat库/" itemprop="url">logcat库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-13T09:44:43+08:00">
                2018-08-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><h2 id="LogCatDialog"><a href="#LogCatDialog" class="headerlink" title="LogCatDialog"></a>LogCatDialog</h2><p>LogCatDialog是一款可以在手机中打开logcat控制台.它的功能特点就是:</p>
<ul>
<li>方便快捷</li>
<li>支持内容搜索</li>
<li>支持自定义标签</li>
<li>支持根据tag筛选</li>
<li>支持根据log级别显示</li>
</ul>
<p><a href="https://github.com/SHPDZY/LogCatDialog" target="_blank" rel="noopener">LogCatDialog项目地址</a></p>
<h2 id="vConsole"><a href="#vConsole" class="headerlink" title="vConsole"></a>vConsole</h2><p>微信团队开源的一个轻量、可拓展、针对手机网页的前端开发者调试面板</p>
<ul>
<li>查看 console 日志</li>
<li>查看网络请求</li>
<li>查看页面 element 结构</li>
<li>查看 Cookies 和 localStorage</li>
<li>手动执行 JS 命令行</li>
<li>自定义插件</li>
</ul>
<p><a href="https://github.com/Tencent/vConsole" target="_blank" rel="noopener">vConsole项目地址</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/13/hexo-帮助/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="beilo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="beilo 技术小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/13/hexo-帮助/" itemprop="url">hexo 帮助</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-13T09:30:58+08:00">
                2018-08-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h2><h3 id="init-新建一个网站。如果没有设置-folder-，Hexo-默认在目前的文件夹建立网站。"><a href="#init-新建一个网站。如果没有设置-folder-，Hexo-默认在目前的文件夹建立网站。" class="headerlink" title="init 新建一个网站。如果没有设置 folder ，Hexo 默认在目前的文件夹建立网站。"></a>init 新建一个网站。如果没有设置 folder ，Hexo 默认在目前的文件夹建立网站。</h3><p><code>$ hexo init [folder]</code></p>
<h3 id="new-新建一篇文章。"><a href="#new-新建一篇文章。" class="headerlink" title="new 新建一篇文章。"></a>new 新建一篇文章。</h3><p><code>$ hexo new [layout] &lt;title&gt;</code></p>
<h3 id="发布到github-pagers"><a href="#发布到github-pagers" class="headerlink" title="发布到github pagers"></a>发布到github pagers</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g -d</span><br><span class="line">https://beilo.github.io/</span><br></pre></td></tr></table></figure>
<h3 id="generate-生成静态文件"><a href="#generate-生成静态文件" class="headerlink" title="generate 生成静态文件"></a>generate 生成静态文件</h3><p><code>$ hexo generate</code> 或者 <code>$ hexo g</code><br>| 选项            | 描述                   |<br>| ————— | ———————- |<br>| <code>-d</code>,<code>--deploy</code> | 文件生成后立即部署网站 |<br>| <code>-w</code>,<code>--watch</code>  | 监视文件变动           |</p>
<h3 id="publish-发表草稿。"><a href="#publish-发表草稿。" class="headerlink" title="publish 发表草稿。"></a>publish 发表草稿。</h3><p><code>$ hexo publish [layout] &lt;filename&gt;</code></p>
<h3 id="server-启动服务器。默认情况下，访问网址为：http-localhost-4000-。"><a href="#server-启动服务器。默认情况下，访问网址为：http-localhost-4000-。" class="headerlink" title="server 启动服务器。默认情况下，访问网址为：http://localhost:4000/。"></a>server 启动服务器。默认情况下，访问网址为：<a href="http://localhost:4000/。" target="_blank" rel="noopener">http://localhost:4000/。</a></h3><p><code>$ hexo server</code><br>| 选项               | 描述                     |<br>| —————— | ———————— |<br>| <code>-g</code>, <code>--generate</code> | 部署之前预先生成静态文件 |</p>
<h3 id="deploy-部署网站。"><a href="#deploy-部署网站。" class="headerlink" title="deploy 部署网站。"></a>deploy 部署网站。</h3><p><code>$ hexo deploy</code> 或者 <code>$ hexo d</code><br>| 选项             | 描述                           |<br>| —————- | —————————— |<br>| <code>-p</code>, <code>--port</code>   | 重设端口                       |<br>| <code>-s</code>, <code>--static</code> | 只使用静态文件                 |<br>| <code>-l</code>, <code>--log</code>    | 启动日记记录，使用覆盖记录格式 |</p>
<h3 id="migrate-从其他博客系统"><a href="#migrate-从其他博客系统" class="headerlink" title="migrate 从其他博客系统"></a>migrate 从其他博客系统</h3><p><code>$ hexo migrate &lt;type&gt;</code></p>
<h3 id="clean-清除缓存文件-db-json-和已生成的静态文件-public-。"><a href="#clean-清除缓存文件-db-json-和已生成的静态文件-public-。" class="headerlink" title="clean 清除缓存文件 (db.json) 和已生成的静态文件 (public)。"></a>clean 清除缓存文件 (db.json) 和已生成的静态文件 (public)。</h3><p><code>$ hexo clean</code></p>
<h3 id="安全模式-在安全模式下，不会载入插件和脚本。"><a href="#安全模式-在安全模式下，不会载入插件和脚本。" class="headerlink" title="安全模式 在安全模式下，不会载入插件和脚本。"></a>安全模式 在安全模式下，不会载入插件和脚本。</h3><p><code>$ hexo --safe</code></p>
<h3 id="调试模式-在终端中显示调试信息并记录到-debug-log。"><a href="#调试模式-在终端中显示调试信息并记录到-debug-log。" class="headerlink" title="调试模式 在终端中显示调试信息并记录到 debug.log。"></a>调试模式 在终端中显示调试信息并记录到 debug.log。</h3><p><code>$ hexo --debug</code></p>
<h2 id="问题以及解决方法"><a href="#问题以及解决方法" class="headerlink" title="问题以及解决方法"></a>问题以及解决方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">1. </span><br><span class="line">JS-YAML: can not read a block mapping entry; a multiline key may not be an implicit key at line 8, column 12:</span><br><span class="line">原因是最上面的 title:等等的冒号后面格式要正常,比如 所有:后面加个空格。</span><br><span class="line"></span><br><span class="line">2.</span><br><span class="line">could not read Username for &apos;https://github.com&apos;: Invalid argument</span><br><span class="line">关联 github 失败,后从https -&gt; ssh.</span><br><span class="line"></span><br><span class="line">3.</span><br><span class="line">npm install hexo-deployer-git --save</span><br><span class="line">git 报错</span><br><span class="line"></span><br><span class="line">4.</span><br><span class="line">开启toc(目录)功能https://pengloo53.gitbooks.io/hexo/content/chapter2/7%20%E6%B7%BB%E5%8A%A0%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95.html</span><br><span class="line">文件目录: </span><br><span class="line">1. myblog\themes\landscape\layout\_partial</span><br><span class="line">2. myblog\themes\landscape\source\css\_partial</span><br><span class="line"></span><br><span class="line">默认展开所有目录</span><br><span class="line">https://github.com/iissnan/hexo-theme-next/issues/531</span><br><span class="line">文件目录: </span><br><span class="line">1. myblog\themes\next\source\css\_custom</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">beilo</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">beilo</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
